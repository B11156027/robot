#include <WiFi.h>
#include <ESPAsyncWebServer.h>
#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>

Adafruit_PWMServoDriver pwm = Adafruit_PWMServoDriver();

const char* ssid = "123";
const char* password = "123456789";
AsyncWebServer server(80);

// çœ¼ç›
const int eyeChannel = 0;
const int eyeOpen = 130;
const int eyeClose = 180;
const int blinkDelay = 4000;
const int blinkSpeed = 150;

// å˜´å·´
const int mouthChannel = 4;
const int mouthClosed = 180;
const int mouthOpen = 130;
const int mouthMoveDelay = 200; // å˜´å·´é–‹åˆæ™‚é–“ (ms)

bool isTalking = false;
bool mouthIsOpen = false;
unsigned long lastMouthMove = 0;

// ===== é ­éƒ¨ =====
const int headChannel = 8;
const int headLeft = 1;
const int headRight = 179;
const int headCenter = 70;

int headCurrent = headCenter;   // ç›®å‰è§’åº¦
int headTarget = headCenter;    // ç›®æ¨™è§’åº¦
const int headStep = 2;         // æ¯æ¬¡æœ€å¤šç§»å‹• 2Â°
const int headInterval = 30;    // æ¯ 30ms æ›´æ–°ä¸€æ¬¡
unsigned long lastHeadUpdate = 0;

// PWM è¨­å®š
const int SERVO_MIN = 500;
const int SERVO_MAX = 2400;
int angleToPWM(int angle) {
  return map(angle, 0, 180, SERVO_MIN * 4096 / 20000, SERVO_MAX * 4096 / 20000);
}

// çœ¨çœ¼è¨ˆæ™‚
unsigned long lastBlink = 0;

void updateMouth() {
  if (!isTalking) return;

  unsigned long now = millis();
  if (mouthIsOpen) {
    if (now - lastMouthMove >= mouthMoveDelay) {
      pwm.setPWM(mouthChannel, 0, angleToPWM(mouthClosed));
      mouthIsOpen = false;
      lastMouthMove = now;
    }
  } else {
    if (now - lastMouthMove >= mouthMoveDelay) {
      pwm.setPWM(mouthChannel, 0, angleToPWM(mouthOpen));
      mouthIsOpen = true;
      lastMouthMove = now;
    }
  }
}

void setup() {
  Serial.begin(9600);
  Wire.begin();
  pwm.begin();
  pwm.setPWMFreq(50);
  delay(10);

  pwm.setPWM(eyeChannel, 0, angleToPWM(eyeOpen));
  pwm.setPWM(mouthChannel, 0, angleToPWM(mouthClosed));
  pwm.setPWM(headChannel, 0, angleToPWM(headCenter));

  // WiFi
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("");
  Serial.print("Connected! IP address: ");
  Serial.println(WiFi.localIP());

  // HTTPæŽ§åˆ¶ï¼šè¨­å®šç›®æ¨™è§’åº¦
  server.on("/servo", HTTP_GET, [](AsyncWebServerRequest *request){
    if(request->hasParam("angle")){
      int angle = request->getParam("angle")->value().toInt();
      if (angle < headLeft) angle = headLeft;
      if (angle > headRight) angle = headRight;
      headTarget = angle;  // âœ… ä¸ç›´æŽ¥ setPWMï¼Œæ”¹æˆè¨­å®šç›®æ¨™è§’åº¦
      request->send(200, "text/plain", String("Head target set to: ") + angle);
    } else {
      request->send(400, "text/plain", "Missing angle");
    }
  });
  server.begin();
  Serial.println("HTTP ä¼ºæœå™¨å•Ÿå‹•å®Œæˆ");
}

void loop() {
  unsigned long now = millis();

  // ðŸ‘ï¸ çœ¨çœ¼
  if (now - lastBlink >= blinkDelay) {
    pwm.setPWM(eyeChannel, 0, angleToPWM(eyeClose));
    delay(blinkSpeed);
    pwm.setPWM(eyeChannel, 0, angleToPWM(eyeOpen));
    lastBlink = now;
  }

  // ðŸŽ™ï¸ å˜´å·´åŒæ­¥ï¼ˆSerialæŽ§åˆ¶ï¼‰
  if (Serial.available()) {
    char cmd = Serial.read();
    if (cmd == 'S') {
      isTalking = true;
    } else if (cmd == 'E') {
      isTalking = false;
      pwm.setPWM(mouthChannel, 0, angleToPWM(mouthClosed));
    }
  }

  updateMouth(); 

  // ðŸŒ€ é ­éƒ¨é™é€Ÿç§»å‹•
  if (now - lastHeadUpdate >= headInterval) {
    if (headCurrent < headTarget) {
      headCurrent = min(headCurrent + headStep, headTarget);
    } else if (headCurrent > headTarget) {
      headCurrent = max(headCurrent - headStep, headTarget);
    }
    pwm.setPWM(headChannel, 0, angleToPWM(headCurrent));
    lastHeadUpdate = now;
  }
}